<form [formGroup]="commentForm" 
      (ngSubmit)="onSubmit()" 
      enctype="multipart/form-data" 
      class="space-y-4 p-6 bg-white rounded-xl shadow-2xl max-w-2xl mx-auto my-8">

  <h2 class="text-3xl font-extrabold text-gray-900 border-b pb-3">
    {{ parentCommentId && parentCommentId > 0 ? ('Reply to comment #' + parentCommentId) : 'Add a Comment' }}
  </h2>

  <div *ngIf="parentCommentId && parentCommentId > 0" 
       class="p-3 bg-indigo-50 text-indigo-700 border-l-4 border-indigo-500 rounded-md shadow-inner">
    You are replying to comment ID: <strong>#{{ parentCommentId }}</strong>.
    <button type="button" (click)="formReset.emit()" 
            class="ml-2 text-sm font-semibold text-indigo-600 hover:underline transition duration-150">
      Cancel Reply
    </button>
  </div>

  <div class="comment-buttons">
    <button type="button" (click)="insertTag('i')" class="btn-italic">Italic</button>
    <button type="button" (click)="insertTag('strong')" class="btn-bold">Bold</button>
    <button type="button" (click)="insertTag('code')" class="btn-code">Code</button>
    <button type="button" (click)="insertLink()" class="btn-link">Link</button>
  </div>

  <div class="comment-block">
    <textarea
      id="Text"
      #textArea
      formControlName="textMessage"
      rows="6"
      placeholder="Enter your comment..."
      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500"
      [ngClass]="{
        'border-red-500 ring-1 ring-red-200':
        getControl('textMessage')?.invalid && getControl('textMessage')?.touched
      }">
    </textarea>
  </div>

  <div class="mt-4 p-4 border border-gray-300 rounded-lg bg-gray-50">
    <label for="file-upload" class="block text-base font-medium text-gray-700 mb-2">
      Attach image or text file
    </label>

    <input type="file" id="file-upload" (change)="onFileSelected($event)"
           class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
           accept=".jpg,.jpeg,.png,.gif,.txt">

    <div *ngIf="fileError" class="text-xs text-red-500 mt-1">{{ fileError }}</div>

    <div *ngIf="filePreviewUrl" class="mt-2">
      <img [src]="filePreviewUrl" alt="File Preview" class="max-w-full h-auto border rounded-md shadow-inner">
    </div>
  </div>

  <div class="user-info-grid">
    <div>
      <label for="UserName">Name *</label>
      <input id="UserName" type="text" formControlName="userName">
    </div>
    <div>
      <label for="Email">Email *</label>
      <input id="Email" type="email" formControlName="email">
    </div>
    <div>
      <label for="HomePage">Website (URL)</label>
      <input id="HomePage" type="url" formControlName="homePage">
    </div>
  </div>

  <div class="captcha-container">
    <label class="captcha-label">
      Confirm you are not a robot <span class="required">*</span>
    </label>

    <div *ngIf="isLoading" class="captcha-loading">
      Loading CAPTCHA...
    </div>

    <div *ngIf="!isLoading" class="captcha-content">
      <div *ngIf="captchaImageUrl" class="captcha-image-wrapper">
        <button type="button" (click)="loadNewCaptcha()" class="captcha-refresh">
          ðŸ”„ Refresh
        </button>
        <img [src]="captchaImageUrl" alt="CAPTCHA Image" class="captcha-image">
      </div>

      <input type="text"
             formControlName="captchaInputText"
             class="captcha-input"
             placeholder="Result">
    </div>

    <div *ngIf="captchaError" class="captcha-error">
      {{ captchaError }}
    </div>

    <div *ngIf="submitError && !captchaImageUrl" class="captcha-error">
      {{ submitError }}
    </div>
  </div>

  <button type="submit" 
          [disabled]="commentForm.invalid || isLoading || !captchaImageUrl" 
          class="w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-xl hover:bg-indigo-700 disabled:opacity-50 transition duration-300 transform hover:scale-[1.01]">
    <span *ngIf="!isLoading">Submit Comment</span>
    <span *ngIf="isLoading">Submitting...</span>
  </button>

</form>
